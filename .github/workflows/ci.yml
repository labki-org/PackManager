name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: ['**']

concurrency:
  group: labkipackmanager-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci || npm install
      - run: npm test
      - run: npm run build
      - name: Check bundle freshness
        run: |
          if ! git diff --quiet -- resources/modules/ext.LabkiPackManager/app.bundle.js resources/css/labkipackmanager.css; then
            echo "::warning ::Built assets are out of date. Please run 'npm run build' and commit the changes."
            exit 1
          fi
      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: labkipackmanager-bundle
          path: |
            resources/modules/ext.LabkiPackManager/app.bundle.js
            resources/modules/ext.LabkiPackManager/app.bundle.js.map

  phpunit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mw_branch: [REL1_44]
        php: ['8.2']
    steps:
      - uses: actions/checkout@v4
        with:
          path: extension

      - name: Get MediaWiki core
        run: |
          git clone https://gerrit.wikimedia.org/r/mediawiki/core.git mediawiki
          cd mediawiki
          git checkout ${{ matrix.mw_branch }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, intl, xml, json, sqlite3
          tools: composer

      - name: Install MW deps
        working-directory: mediawiki
        run: composer update --no-interaction

      - name: Install MW with SQLite
        working-directory: mediawiki
        run: |
          mkdir -p cache/sqlite
          php maintenance/install.php \
            --dbtype sqlite --dbpath $(pwd)/cache/sqlite \
            --server "http://example.local" --scriptpath "/w" \
            --lang en --pass StrongDockerPass123! Wiki Admin

      - name: Enable extension
        run: |
          mkdir -p mediawiki/extensions
          ln -s "$(pwd)/extension" "mediawiki/extensions/LabkiPackManager"
          echo "wfLoadExtension( 'LabkiPackManager' );" >> mediawiki/LocalSettings.php
          echo "\$wgCacheDirectory = \"\$IP/cache\";" >> mediawiki/LocalSettings.php


      - name: Check schema SQL freshness
        working-directory: mediawiki
        run: |
          # Regenerate schemas from abstract definition
          php maintenance/run.php generateSchemaSql \
            --json=extensions/LabkiPackManager/sql/tables.json \
            --sql=extensions/LabkiPackManager/sql/mysql/tables-generated.sql \
            --type=mysql
          php maintenance/run.php generateSchemaSql \
            --json=extensions/LabkiPackManager/sql/tables.json \
            --sql=extensions/LabkiPackManager/sql/sqlite/tables-generated.sql \
            --type=sqlite
          
          # Normalize source path comment (line 2) for consistent comparison
          # The absolute path differs between local dev and CI environments
          cd extensions/LabkiPackManager
          sed -i '2s|Source: .*sql/tables.json|Source: sql/tables.json|' sql/mysql/tables-generated.sql
          sed -i '2s|Source: .*sql/tables.json|Source: sql/tables.json|' sql/sqlite/tables-generated.sql
          
          # Check if generated files differ from committed versions
          if ! git diff --quiet -- sql/mysql/tables-generated.sql sql/sqlite/tables-generated.sql; then
            echo "::error ::Generated SQL schemas are out of date with tables.json"
            echo "::error ::Please run './maintenance/regenerateSchema.sh' and commit the changes."
            git diff sql/mysql/tables-generated.sql sql/sqlite/tables-generated.sql
            exit 1
          fi
          echo "âœ“ Schema SQL files are up to date"

      - name: Update DB schema
        working-directory: mediawiki
        run: php maintenance/update.php --quick

      - name: Verify labki tables
        working-directory: mediawiki
        run: |
          php maintenance/sql.php --query="SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'labki_%';"

      - name: PHPUnit unit
        working-directory: mediawiki
        run: |
          if [ -d "extensions/LabkiPackManager/tests/phpunit/unit" ]; then
            composer phpunit:entrypoint -- extensions/LabkiPackManager/tests/phpunit/unit
          else
            echo "No unit tests directory found; skipping."
          fi

      - name: PHPUnit integration
        working-directory: mediawiki
        env:
          PHPUNIT_WIKI: wiki
        run: |
          if [ -d "extensions/LabkiPackManager/tests/phpunit/integration" ]; then
            composer phpunit:entrypoint -- extensions/LabkiPackManager/tests/phpunit/integration
          else
            echo "No integration tests directory found; skipping."
          fi
